# Chill Env Sync (Real-Time Weather Sync Mod)

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![.NET Framework 4.7.2](https://img.shields.io/badge/.NET%20Framework-4.7.2-blue.svg)](https://dotnet.microsoft.com/download/dotnet-framework/net472)
[![BepInEx](https://img.shields.io/badge/BepInEx-Plugin-green.svg)](https://github.com/BepInEx/BepInEx)

A BepInEx plugin for Chill with You – A Lo-Fi Story with You. It syncs in-game environments with real-world weather, or simulates day–night cycles based on real time.

---

[![Chill with You](./CWYLS-EN.jpg)](https://store.steampowered.com/app/3548580/)

> Chill with You Lo-Fi Story is a voiced novel/work-with-me game featuring Satone. You can customize music, ambience, and scenery to build a focused working environment. As your relationship deepens, something special may or may not happen.
---



All code was generated by AI; human work was limited to decompiling and fixing.
This is a fork oriented to be used with OpenWeather's API for international users.

---

Related mod：[iGPUSaviorMod](https://github.com/Small-tailqwq/iGPUSaviorMod)  


## ✨ Main Features

- 🌤️ **Real-time weather sync** via Seniverse or OpenWeather APIs
- 🌍 **Multi-city and multi-provider support**
- 🌓 **Automatic day/night cycle** based on sunrise and sunset
- 🔓 **Optional unlock-all** for environments and decorations
  - Session-only, does not modify save files
	  - `UnlockAllEnvironments`：Unlocks all environments
	  - `UnlockAllDecorations`： Unlocks all decorations
- ⌨️ **Hotkeys**：
  - `F7` - Force refresh weather (bypass cache)
  - `F8` - F8 – Log current state
  - `F9` - Force re-apply environment using cached data

## ⚠️ Notes

- 💽**Possible “cheat-like” behavior**：Unlocking environments is temporary, but still modifies runtime state
- 💥**Potential conflicts** with future updates or other mods
- 🧷**External API** relies on third-party weather providers
- 😵‍💫**AI-written code**：Expect errors, currently testing this version with OpenWeather's API
- 🔓**OneCall API:** Although OneCall's API is free for the first thousand calls of the day, it requires subscribing to it to be able to utilise that API, therefore, I'm currently making changes for it to be available with OpenWeather's free weather API.


## 🎮 Supported Environment Types

### Base Environments (mutually exclusive)

- ☀️ Day
- 🌅 Sunset
- 🌙 Night
- ☁️ Cloudy

### Precipitation Effects
- 🌧️ LightRain
- 🌧️ HeavyRain
- ⛈️ ThunderRain
- ❄️ Snow

### Scenery Effects
Triggered automatically if seasonal/easter-egg automation is enabled.

### Sound Effects
Also auto-triggered when conditions are met.

### TODO

>  🗒️ Fix the mod for OpenWeather

## 📦 Installation

### Requirements
- The game
- [BepInEx 5.4.23.4](https://github.com/BepInEx/BepInEx/releases)

### Steps

1. Install BepInEx in the game's folder (with the EXE)
2. Launch the game once, then exit
3. Place `RealTimeWeatherMod.dll` into `BepInEx/plugins/`
4. Launch the game
5. Edit config, press F7 in-game to reload

## ⚙️ Configuration

After the first run, the configuration file is generated here: `BepInEx/config/chillwithyou.envsync.cfg`

### Weather API Providers (merged)
This fork supports both Seniverse and OpenWeather.
Select one via the WeatherProvider field:
| Provider        | Location Format                               | Notes                                    |
| --------------- | --------------------------------------------- | ---------------------------------------- |
| **Seniverse**   | City name (e.g., `beijing`, `上海`, `new york`) | Good for Chinese users; lower free quota |
| **OpenWeather** | `lat,lon` (e.g., `40.7128,-74.0060`)          | Global; 1000/day free quota              |


**Sample Config Snippets**
```ini
Seniverse
[WeatherAPI]
EnableWeatherSync = true
WeatherProvider = Seniverse
ApiKey = YOUR_SENIVERSE_KEY
Location = beijing

OpenWeather
[WeatherAPI]
EnableWeatherSync = true
WeatherProvider = OpenWeather
ApiKey = YOUR_OPENWEATHER_KEY
Location = 40.7128,-74.0060

WeatherSync
[WeatherSync]
RefreshMinutes = 30

Time Settings
[TimeConfig]
Sunrise = 06:30
Sunset = 18:30

UI Settings
[UI]
ShowWeatherOnDate = true

Automation
[Automation]
EnableSeasonalEasterEggs = true

Unlock Options
[Unlock]
UnlockAllEnvironments = true
UnlockAllDecorations = true

Debug Options
[Debug]
EnableDebugMode = false
SimulatedCode = 13
SimulatedTemp = 13
SimulatedText = DebugWeather
```

### Obtaining the API Key
- **Seniverse:**
> 💡 新版本内置密钥，留空也可用天气服务。自己申请也可用，看个人喜好

1. 访问 [心知天气开发者平台](https://www.seniverse.com/)
2. 注册账号并登录，转到 `控制台` - `产品管理` - `免费版`(如果你是试用版或者其他版本，请选择对应版本)
3. 在产品管理中找到 **私钥**，复制该密钥
4. 将该私钥填入配置文件的 `SeniverseKey` 字段，无需添加引号等特殊符号
5. 设置 `EnableWeatherSync = true` 启用天气同步
6. 可按需配置刷新时间，避免API调用过于频繁
7. 如有不懂之处，可以参阅 issues。



## 🚀 Usage

### Basic Usage (Enabled by Default)

The plugin automatically switches environments based on configured sunrise and sunset times:
- 1 hour after sunrise to 1 hour before sunset: Daytime
- 30 minutes before sunset to 30 minutes after sunset: Twilight
- All other times: Nighttime

### Weather Sync Mode (Requires Enabling)

1. Configure the API Key as described above
2. The plugin will automatically fetch weather data and update the environment at specified intervals (default: 30 minutes)

3. Environment Mapping Rules:

| Environment | Normal Weather | Severe Weather |
|------|---------|---------|
| ☀️ Day | Sunrise → 30 min before sunset | — |
| 🌅 Sunset | 30 min before sunset → 30 min after sunset | — |
| ☁️ Cloudy | — | Sunrise → 30 min after sunset |
| 🌙 Night | 30 minutes after sunset → Sunrise | 30 minutes after sunset → Sunrise |  

> 💡 During severe weather, daytime and sunset periods uniformly display as cloudy conditions, and sunset effects are skipped. Nighttime environments remain unaffected by weather and always transition precisely 30 minutes after sunset.

Translated with DeepL.com (free version)

4. Rain/Snow Effect Logic (internal)：

```
Snow: codes 20–25
ThunderRain: 11,12,16–18
HeavyRain: 10,14,15
LightRain: 13,19
Off: 0–9, 26–39 (clear/cloudy/fog/wind)

```
5. 天气映射规则：

| 游戏效果代码 | 对应 API 天气 ID (参考)       | 逻辑说明                                             |
| ------------ | ----------------------------- | ---------------------------------------------------- |
| Snow         | 20-25 (雪/雨夹雪/暴雪)        | 所有的雪类，统统下雪。                               |
| ThunderRain  | 11, 12, 16, 17, 18 (雷/暴雨)  | 雷阵雨、暴雨、特大暴雨，上强度。                     |
| HeavyRain    | 10, 14, 15 (阵雨/中雨/大雨)   | 普通的下雨，量比较大。                               |
| LightRain    | 13, 19 (小雨/冻雨)            | 淅淅沥沥的小雨。                                     |
| OFF (关闭)   | 0-9, 26-39 (晴/多云/阴/雾/风) | 关键点：如果是阴天或多云，必须强制关闭所有雨雪效果！ |

| OpenWeather ID | Internal Code | Meaning      |
| -------------- | ------------- | ------------ |
| 800            | 0             | Clear        |
| 801–804        | 4–9           | Cloudy       |
| 500–531        | 10–14         | Rain         |
| 200–232        | 11            | Thunderstorm |
| 600–622        | 22–25         | Snow         |
| 701–781        | 26            | Fog/Mist     |


### 快捷键功能

- **F7**：立即强制刷新天气（跳过缓存）
	- 核心目的：
		- 忽略缓存，强制从心知天气 API 获取最新的实时天气数据。
	- 重置 API 慢钟计时器。
		- 触发行为：
			1. 清空计时器：重置下次自动请求 API 的倒计时。
			2. 强制联网：无视 CacheExpiry（60分钟缓存期），直接向 api.seniverse.com 发起 HTTP 请求。
			3. 数据更新：如果请求成功，会用新的天气数据覆盖内存中的 _cachedWeather。
			4. 自动应用：拿到新数据后，会自动调用 ApplyEnvironment 来更新游戏场景。
	- 适用场景：
		- 你觉得天气变了（比如窗外刚下雨了），但游戏里还是晴天（因为还在缓存期内）。
		- 调试 API 连接是否正常。
		- 修改了配置文件中的 Location（城市）后，想立即生效。
- **F8**：在日志中显示当前环境状态
	- 打印一条日志
- **F9**：手动触发一次天气同步
	- 核心目的：
	  - 不联网，使用当前已有的天气缓存和实时的本地时间，强制重新计算并应用游戏环境。
	  - 关键点：它会绕过“防抖动”检查（即 if (Current == Target) return），强制执行一次完整的环境切换流程（关灯 -> 开灯 -> 服务同步）。
	- 触发行为：
	  1. 读取缓存：直接读取内存中的 _cachedWeather（如果没缓存，只算时间）。
	  2. 重算时间：根据当前秒数 (DateTime.Now)，重新计算是白天、黄昏还是夜晚。
	
	  3. 暴力执行：
	
	     - 调用 ForceActivateEnvironment。
	
	     - 强制模拟点击 MainIcon（即使它看起来是亮着的）。
	
	     - 强制调用 WindowViewService.ChangeWeatherAndTime。
	
	     - 强制写入 SaveDataManager。
	- 适用场景：
	  - 修复错位：比如游戏 UI 显示是“雨天”，但画面上雨停了；或者声音还在响，但图标灭了。按 F9 可以“踢”一下游戏，让它回正。
	  - 日落/日出测试：当你觉得时间到了（比如17:30），但游戏没切黄昏（可能是快钟还没跳），按 F9 可以立即触发时间判断。
	  - 无网状态：断网时，F7 会失败，但 F9 可以用来刷新本地时间逻辑（白天/夜晚切换）。

## 🔧 技术细节

- **框架**：BepInEx 5.x
- **目标框架**：.NET Framework 4.7.2
- **使用技术/工具**：
  - Harmony 补丁（用于游戏功能注入）
  - Unity 协程（用于异步网络请求）
  - 反射（用于访问游戏内部系统）
  - dnSPY
  - 各种大语言模型

## 📝 版本历史
> 注：版本号为 AI 自己写的，不关我的事，我也不知道为啥它刷版本号为什么这么随意
### v5.1.2-老坛酸菜版（？
- 内置了一个 KEY，当发现 KEY 异常调用时，不排除强行重置行为
- 修复了可能导致 UI 控件无法交互的问题  
- 修复了背景音乐在彩蛋模式激活后无法关闭的问题  
- 修复了天气开关被错误统计到脏目录的问题  

### b5.1.1
- 添加了一个改写上午/下午的功能，现在是凌晨、清晨、上午、中午、下午、傍晚、晚上了

### b5.0.1-煮饭时间到
- 没啥变化，只是把风景啥的的枚举类丢给 Gemini 让他写上去了，这 B 这都要刷一个版本号，我服了
- 此版本应该是游戏本体下一次更新前的定稿版本了，除非有 bug 需要修复，暂时想不到新功能了。你有好的想法也可以提出来。

### v5.0.0
- 什么？版本直接跳到 v5 了？你都干了些什么口牙！
- 独立组件：新建一个 `SceneryAutomationSystem` 类（继承 `MonoBehaviour`），挂载在 `Runner` 上，这样它有自己的 `Update` 循环，不干扰原本的天气同步逻辑
- 规则驱动：Gemini 它把“做饭声音”、“空调声音”、“樱花”、“烟花”等抽象成了 `SceneryRule`。这样以后我想加新彩蛋，只需要在列表里加一行配置，不用改核心代码
- 用户防打架机制 (脏标记)：这是核心。通过 `Hook` 游戏的点击事件，一旦用户手动点过某个开关，系统就把这个开关拉入“黑名单”，本局游戏不再自动接管。(<---这不是偷懒吗？）
- 注：彩蛋功能的触发机制举例起来比较麻烦，有能力者可以把代码丢给 AI 或者自行分析，目前只使用了部分参数进行判断，后续游戏更新后可能会根据情况进行优化。

### v4.5.0
- 添加了一个在主界面左上角日期后显示天气和温度的功能
- 添加了一个可选配置项 `ShowWeatherOnDate`,用于控制是否在日期后追加显示天气和温度
- 此功能需要引用 `Unity.TextMeshPro.dll`

### v4.4.1-更好的天空
- 守护了部分人的白天或者是黄昏
- 将小雨、小雪、阵雨、阵雪这种非恶劣天气从恶劣天气名单中移除

### v4.4.0
- 守护了这片夜空
- 重构了环境、风景推导逻辑，现在晚上永远只会是晚上，白天恶劣天气可能会是多云，也可能是白天和黄昏，谁知道呢

### v4.3.1
- 说是优化了 v4.3.0 出现问题的原因
- 捏吗你不能修复的时候一并优化吗？

### v4.3.0
- 修复了一个在多云状态下按 `F9` 会导致所有环境被错误关闭的问题

### v4.2.3-V4.2.4
- 还是没修好，Gemini 出去

### v4.2.2
- 发现了一个在多云状态下按 `F9` 会导致所有环境被错误关闭的问题
- 然后这 Gemini 没修好

### v4.2.1
- 添加了一个调试模式，开始尝试调整调整天气 ID 查看对应天气切换效果（什么？你现在才开始测试？！）
- 让 Gemini 别刷版本号了

### v4.2.0
- 修复了一个按 `F7` 没反应的问题，加了个输出说是

### v3.7.0-v4.1.0-外地AI刷版本号来了
- 优化 `F9` 按键逻辑，优化日志提示
- 修复偶发日志卡死的状态，即使不影响使用
- 修复之前和AI沟通的错误：它一直以为黄昏要提前1小时切换，实际上是30分钟
- 优化切换逻辑（真是优化？）

> 缓存逻辑是这样的：
> - 数据存储：有一个静态变量 `_cachedWeather` 存在内存里。
> - 有效期：60 分钟 (`TimeSpan.FromMinutes(60)`).
> - 快钟 (30 秒一次)：
> 	- 只读缓存。如果缓存里有数据，直接拿来用，不发网络请求（不费流量）。
> 	- 它会利用缓存里的“晴/雨”状态，重新结合“当前每一秒的时间”来判断是否该日落了。
> 	- 注：本来想让 AI 写定时器的，但是 AI 说不如这个，我不懂所以听他的
> - 慢钟 (30 分钟一次)：
> 	- 强制更新。即使缓存没过期（60 分钟），只要到了用户设定的刷新间隔（默认 30 分钟），就会尝试发起新的 API 请求来刷新数据。

### v3.6.0-不想开挂？满足你
- 增加解锁所有环境和装饰品可选配置项

### v3.5.0-估摸着能跑版
- 优化按钮逻辑，采用模拟点击 `MainIcon` 方式
- 修复环境切换可能不生效的问题
- 改进代码结构和日志输出

### v3.4.x
- 修复部分天气效果无法关闭的问题
- 优化环境互斥逻辑

### v3.3.0 及更早版本
- 分析源码、分析环境开关逻辑、分析景色开关逻辑
- 初始版本开发
- 谁能想到用了3个不同厂商的不同AI写了一天才写出来，我累死了

详细更新日志请查看 [Git 提交记录](https://github.com/Small-tailqwq/RealTimeWeatherMod/commits/master)

## 🐛 已知问题

- 首次加载可能需要等待 15 秒后才会进行第一次环境同步（这玩意应该不算问题吧？~~男人不能说太快，所以我加了点延迟？~~）
- 部分天气会错误触发管理名单系统`[用户交互] 用户接管了 HeavyRain，停止自动托管。`
	- 但是该报错并不影响自动切换天气的逻辑

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

### 关于反馈

如需反馈问题，请先确保问题“可复现”，并开启调试日志（BepInEx/config/BepInEx.cfg 中将 `Logging.Console` 设置为 `true`）。  
这时，游戏启动时会在控制台输出详细日志，有助于定位问题。

## 📄 许可证

本项目采用 **MIT 许可证** 开源。

**⚠️ 重要声明**：
- ✅ 可以自由使用、修改和分发
- ✅ 可以用于个人学习和研究
- 使用本软件产生的任何后果由使用者自行承担

详见 [LICENSE](LICENSE) 文件。

## 👨‍💻 作者

- GitHub: [@Small-tailqwq](https://github.com/Small-tailqwq)

## 🙏 致谢

- BepInEx 团队
- Harmony 补丁库
- 心知天气 API 服务
- Google Gemini3Pro
- OpenAI ChatGPT5.1
- Claude Sonnet and Ops 4.5
- 我的肝脏和眼球还有我的屁股
	- 该换一个好椅子了
	- 整点眼药水


---

**免责声明**：本插件仅供学习交流使用，请勿用于商业用途。使用本插件产生的任何问题与作者无关。


> 我的桌上常有一盏熔岩灯
